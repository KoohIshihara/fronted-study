<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>Todo</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jade/1.11.0/jade.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/riot/2.3.18/riot+compiler.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  </head>
  <body>
    <app title="Riot.js"></app>
  </body>
</html>

<script type="riot/tag" template='jade'>
app
  h1 test
  h1 { todoH }
  
  input(type = "text", id = "todoText")
  input(type = "button", value = "addTodo", onclick = "{addTodo}")
  br
  input(type = "button", value = "Remove completed todo!!", onclick = "{removeTodo}")


  ul.todoLists
    li.list(each="{ todoList }")
      input(type = "checkbox", onchange = "{checkedTodo}", checked = "{ done }")
      span { title }
      input(type = "button", value = "edit", onclick = "{ editTodo }")


  script.
    // todoを読み込む
    this.on('mount', function() {
      // 読み込みとstr to JSON
      var todoList_str = localStorage.getItem('todoList_str');

      if( todoList_str ) {
        var todoList_JSON = JSON.parse(todoList_str);
        this.todoList = todoList_JSON;
      } else{
        this.todoList = [];
      }

      this.update();
    });

    // todoListを保存
    this.saveTodo = function(){

      // JSONtoStr
      var todoList_str = JSON.stringify( this.todoList );
      // str化したデータを保存
      localStorage.setItem('todoList_str', todoList_str);

    }

    // todoリストを追加する関数
    this.addTodo = function(){

      // テキストを取得
      var newTodoText = document.getElementById("todoText").value;

      // テキストが空の場合、リターンする。
      if( newTodoText == "" ){
        alert('テキストを入力してください。');
        return;
      }

      // テキストに基づいてsavedTodoに追加するオブジェクトをつくる。
      var newTodo = new Object();
      newTodo.index = this.todoList.length;
      newTodo.title = newTodoText;
      newTodo.done = false;
      // savedTodoに追加
      var todoCount = this.todoList.length;
      this.todoList[ todoCount ] = newTodo; 
      // 保存する。
      this.saveTodo();

    }

    // todoのチェックが変更された時
    this.checkedTodo = function() {

     // li要素を全て取得
      var lists = $('.todoLists li');

      // リストの数ループ
      for(var i = 0; i < lists.length; i++){

       // 直下のinput要素をliから取得
       var li = $(lists[i]);
       var input = li.find('input');
        // チェックがついている時
       if( input.prop('checked') ){
          this.todoList[i].done = true;
       }else{
          this.todoList[i].done = false;
        }

     }

     this.saveTodo();
  
    }

    // todoを削除
    this.removeTodo = function(){

      // 更新する新しい配列を宣言
      var newTodoList = [];
   
      // todoListの配列の長さだけループさせる 
      Object.keys(this.todoList).forEach(function(key) {
        // チェックがついていないもののみ追加していく
        if( !(this.todoList[key].done) ){
         // indexの上書き
          this.todoList[key].index = newTodoList.length;
          newTodoList[ newTodoList.length ] = this.todoList[key];
        }
      }.bind(this));

      // 新しいtodoListをセーブする
      this.todoList = newTodoList;
      this.saveTodo();
    }


    this.editTodo = function(e){

      var editingIndex = e.item.index;

      // 変更前のテキスト
      var beforeText = this.todoList[ editingIndex ].title;

      // 変更するテキストを取得
      var afterText = prompt("変更内容を入力してー", beforeText);

      if( afterText.length == 0 ){
        alert("変更内容を入力してください。");
        return;
      }

      this.todoList[ editingIndex ].title = afterText;

      this.saveTodo();
    };


</script>


<script>

  
riot.mount('*');

</script>